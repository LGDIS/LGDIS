<% if issue %>
<%= stylesheet_link_tag 'issue', :plugin => 'lgdis' %>

<table class="attributes">
<%= issue_fields_rows do |rows|
  if issue.xml_control_status
    rows.left l(:field_xml_control_status), h(issue.xml_control_status), :class => 'xml_control_status'
  end
  if issue.xml_control_editorialoffice
    rows.right l(:field_xml_control_editorialoffice), h(issue.xml_control_editorialoffice), :class => 'xml_control_editorialoffice'
  end
  if issue.xml_control_publishingoffice
    rows.left l(:field_xml_control_publishingoffice), h(issue.xml_control_publishingoffice), :class => 'xml_control_publishingoffice'
  end
  if issue.xml_control_cause
    rows.right l(:field_xml_control_cause), h(issue.xml_control_cause), :class => 'xml_control_cause'
  end
  if issue.xml_control_apply
    rows.left l(:field_xml_control_apply), h(issue.xml_control_apply), :class => 'xml_control_apply'
  end
  if issue.xml_head_title
    rows.right l(:field_xml_head_title), h(issue.xml_head_title), :class => 'xml_head_title'
  end
  if issue.xml_head_reportdatetime
    rows.left l(:field_xml_head_reportdatetime), format_time(issue.xml_head_reportdatetime), :class => 'xml_head_reportdatetime'
  end
  if issue.xml_head_targetdatetime
    rows.right l(:field_xml_head_targetdatetime), format_time(issue.xml_head_targetdatetime), :class => 'xml_head_targetdatetime'
  end
  if issue.xml_head_targetdtdubious
    rows.left l(:field_xml_head_targetdtdubious), h(issue.xml_head_targetdtdubious), :class => 'xml_head_targetdtdubious'
  end
  if issue.xml_head_targetduration
    rows.right l(:field_xml_head_targetduration), h(issue.xml_head_targetduration), :class => 'xml_head_targetduration'
  end
  if issue.xml_head_validdatetime
    rows.left l(:field_xml_head_validdatetime), format_time(issue.xml_head_validdatetime), :class => 'xml_head_validdatetime'
  end
  if issue.xml_head_eventid
    rows.right l(:field_xml_head_eventid), h(issue.xml_head_eventid), :class => 'xml_head_eventid'
  end
  if issue.xml_head_infotype
    rows.left l(:field_xml_head_infotype), h(issue.xml_head_infotype), :class => 'xml_head_infotype'
  end
  if issue.xml_head_serial
    rows.right l(:field_xml_head_serial), h(issue.xml_head_serial), :class => 'xml_head_serial'
  end
  if issue.xml_head_infokind
    rows.left l(:field_xml_head_infokind), h(issue.xml_head_infokind), :class => 'xml_head_infokind'
  end
  if issue.xml_head_infokindversion
    rows.right l(:field_xml_head_infokindversion), h(issue.xml_head_infokindversion), :class => 'xml_head_infokindversion'
  end
  if issue.xml_head_text
    rows.left l(:field_xml_head_text), h(issue.xml_head_text), :class => 'xml_head_text'
  end
end %>
</table>

<% if val = issue.xml_control %>
<hr />
<table class="attributes">
<tr>
  <th class="xml_control"><%= l(:field_xml_control) %>:</th>
</tr>
</table>
<%= print_xml_field(val, "xml_control") %>
<% end %>

<% if val = issue.xml_head %>
<hr />
<table class="attributes">
<tr>
  <th class="xml_head"><%= l(:field_xml_head) %>:</th>
</tr>
</table>
<%= print_xml_field(val, "xml_head") %>
<% end %>

<% if val = issue.xml_body %>
<hr />
<table class="attributes">
<tr>
  <th class="xml_body"><%= l(:field_xml_body) %>:</th>
</tr>
</table>
<%= print_xml_field(val, "xml_body") %>
<% end %>

<fieldset class="collapsible collapsed">
<legend onclick="toggleFieldset(this);"><%= l(:map) %></legend>
    <div style="display: none;" id="map_canvas" class="map_field"></div>
</legend>
</fieldset>

<% content_for :header_tags do %>
   <%= javascript_include_tag "//maps.google.com/maps/api/js?sensor=false&language=ja" %>
<% end %>

<script>
  //<![CDATA[
  // 地図表示
  function initialize(){
    <% issue_ad = issue.issue_geographies
       lat  = MAP_VALUES['ishi_lat']
       lon  = MAP_VALUES['ishi_lon']
       addr = MAP_VALUES['ishi_addr']
=begin
       unless issue_ad.blank?
         lat = issue_ad.first.latitude.blank? ? MAP_VALUES['ishi_lat'] : issue_ad.first.latitude
         lon = issue_ad.first.longitude.blank? ? MAP_VALUES['ishi_lon'] : issue_ad.first.longitude
         addr = issue_ad.first.address.blank? ? MAP_VALUES['ishi_addr'] : issue_ad.first.addr
       end
=end
    %>
    var lat  = <%= lat %>;
    var lon  = <%= lon %>;
    var addr = <%== "'#{addr}'" %>;

    var initPos = new google.maps.LatLng(lat, lon);
    var myOptions = {
        center: initPos,
        zoom: 13,
        mapTypeId: google.maps.MapTypeId.ROADMAP
       // scaleControl: true
       // noClear: true
    };
    var mapdiv = document.getElementById('map_canvas');
    var map = new google.maps.Map(mapdiv, myOptions);

    // マーカ
    var marker = new google.maps.Marker({
      // TODO
      position: new google.maps.LatLng(lat, lon),
      map: map
    });
    // ポップアップ
    var infowindow = new google.maps.InfoWindow({
      // TODO
      content: addr
    });

    // TODO
    // issue_geographies テーブルより取得
    var points = [
      new google.maps.LatLng(35.003355,135.742607),
      new google.maps.LatLng(35.009014,135.770159),
      new google.maps.LatLng(34.98604,135.779815),
      new google.maps.LatLng(34.963834,135.755997),
      new google.maps.LatLng(35.003355,135.742607)
    ];
    var polygonOptions = {
      paths: points,
      strokeWeight: 5,
      strokeColor: "#0000ff",
      strokeOpacity: 1.5,
      fillColor: "#008000",
      fillOpacity: 1.5,
      map : map
    };
    var poly = new google.maps.Polygon(polygonOptions);
  }
  google.maps.event.addDomListener(window, 'load', initialize);
  //]]>
</script>
<% end %>

